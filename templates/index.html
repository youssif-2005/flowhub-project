<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowHub | AI OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Grotesk:wght@400;700&display=swap');
        body { background-color: #0F1115; color: white; font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Space Grotesk', sans-serif; }
        .glass-card { background: rgba(20, 20, 25, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .glass-card:hover { border-color: #CCFF00; box-shadow: 0 0 20px rgba(204, 255, 0, 0.2); transform: translateY(-5px); }
        .text-neon { color: #CCFF00; }
        .bg-neon { background-color: #CCFF00; color: black; }
        .border-neon { border-color: #CCFF00; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#0F1115] min-h-screen flex flex-col items-center p-6">

    <nav class="w-full max-w-6xl flex justify-between items-center mb-12 glass-card p-4 rounded-xl border-none">
        <div class="flex items-center gap-2">
            <i data-lucide="hexagon" class="text-neon w-8 h-8"></i>
            <span class="font-display text-2xl font-bold tracking-wider">FLOW<span class="text-neon">HUB</span></span>
        </div>
        {% if mode != 'home' %}
        <a href="/" class="text-xs font-mono text-gray-400 hover:text-neon flex items-center gap-1">
            <i data-lucide="arrow-left" class="w-3 h-3"></i> BACK TO HOME
        </a>
        {% endif %}
    </nav>

    <main class="w-full max-w-5xl">

        {% if mode == 'home' %}
        <div class="text-center mb-10"><h1 class="font-display text-5xl font-bold mb-2">Command Center</h1><p class="text-gray-400">Select a module to begin.</p></div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <a href="/recommendations_menu" class="glass-card p-8 rounded-2xl flex flex-col items-center text-center group cursor-pointer"><div class="bg-gray-800 p-4 rounded-full mb-4 group-hover:bg-neon group-hover:text-black transition"><i data-lucide="brain-circuit" class="w-8 h-8"></i></div><h3 class="font-display text-2xl font-bold">AI Recommendations</h3><p class="text-sm text-gray-400 mt-2">Smart sourcing.</p></a>
            <a href="/orders" class="glass-card p-8 rounded-2xl flex flex-col items-center text-center group cursor-pointer"><div class="bg-gray-800 p-4 rounded-full mb-4 group-hover:bg-blue-500 group-hover:text-white transition"><i data-lucide="package-check" class="w-8 h-8 text-blue-400 group-hover:text-white"></i></div><h3 class="font-display text-2xl font-bold">Manage Orders</h3><p class="text-sm text-gray-400 mt-2">Live production.</p></a>
            
            <div onclick="document.getElementById('ai-modal').classList.remove('hidden')" class="glass-card p-8 rounded-2xl flex flex-col items-center text-center group cursor-pointer border-purple-500/30">
                <div class="bg-gray-800 p-4 rounded-full mb-4 group-hover:bg-purple-500 group-hover:text-white transition">
                    <i data-lucide="bot" class="w-8 h-8 text-purple-400 group-hover:text-white"></i>
                </div>
                <h3 class="font-display text-2xl font-bold">AI Assistant</h3>
                <p class="text-sm text-gray-400 mt-2">API Connected.</p>
            </div>
        </div>

        <div id="ai-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="w-full max-w-2xl glass-card rounded-3xl overflow-hidden flex flex-col h-[600px] border-purple-500/30">
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-500 p-2 rounded-lg"><i data-lucide="bot" class="text-white w-5 h-5"></i></div>
                        <h3 class="font-bold">SupplyChain GPT</h3>
                    </div>
                    <button onclick="document.getElementById('ai-modal').classList.add('hidden')" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
                </div>
                <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-4 flex flex-col custom-scrollbar">
                    <div class="bg-white/5 p-4 rounded-2xl rounded-bl-none max-w-[80%] self-start border border-white/10">
                        Hello! I'm connected to the production API. How can I help?
                    </div>
                </div>
                <form id="chat-form" class="p-4 bg-black/40 border-t border-white/10 flex gap-2">
                    <input type="text" id="user-input" autocomplete="off" placeholder="Type your message..." class="flex-1 bg-white/5 border border-white/10 p-4 rounded-xl outline-none focus:border-purple-500 text-sm">
                    <button type="submit" class="bg-purple-500 p-4 rounded-xl hover:bg-purple-400 transition"><i data-lucide="send" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>
        {% endif %}

        {% if mode == 'orders_dashboard' %}
        <div class="flex justify-between items-end mb-8">
            <div><h2 class="font-display text-4xl font-bold">Production Lines</h2><p class="text-gray-400 mt-1">Live grid status.</p></div>
            <a href="/create_order" class="bg-neon text-black font-bold px-6 py-3 rounded-xl hover:bg-white transition flex items-center gap-2 shadow-[0_0_15px_rgba(204,255,0,0.4)]">
                <i data-lucide="plus" class="w-4 h-4"></i> New Order
            </a>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% for order in orders %}
            <div class="glass-card p-6 rounded-2xl relative overflow-hidden {% if order.is_new %}border-neon shadow-[0_0_15px_rgba(204,255,0,0.15)]{% endif %}">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center gap-3"><div class="bg-white/10 p-2 rounded-lg"><i data-lucide="box" class="w-5 h-5 text-neon"></i></div><div><h4 class="font-bold text-lg">{{ order.product }}</h4><p class="text-xs text-gray-400 font-mono">{{ order.id }}</p></div></div>
                    <span class="text-xs font-bold uppercase {{ order.color }} border border-white/10 px-2 py-1 rounded">{{ order.status }}</span>
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm mb-4"><div><p class="text-[10px] text-gray-500 uppercase">Fabric</p><p class="font-bold">{{ order.fabric }}</p></div><div><p class="text-[10px] text-gray-500 uppercase">Factory</p><p class="font-bold">{{ order.factory }}</p></div></div>
                <div class="mt-2"><div class="flex justify-between text-xs mb-1"><span class="text-gray-400">Progress</span><span class="text-neon font-mono">{{ order.progress }}%</span></div><div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden"><div class="bg-neon h-full rounded-full" style="width: {{ order.progress }}%"></div></div></div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if mode == 'create_order' %}
        <div class="max-w-2xl mx-auto glass-card p-10 rounded-3xl">
            <h2 class="font-display text-3xl font-bold mb-8 text-center">Initiate Production</h2>
            <form action="/submit_order" method="post" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Product</label><select name="product_type" class="w-full bg-black/40 border border-gray-600 p-4 rounded-xl text-white outline-none focus:border-neon">{% for prod in products %}<option value="{{ prod }}">{{ prod }}</option>{% endfor %}</select></div>
                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Fabric</label><select name="fabric_type" class="w-full bg-black/40 border border-gray-600 p-4 rounded-xl text-white outline-none focus:border-neon">{% for fab in fabrics %}<option value="{{ fab }}">{{ fab }}</option>{% endfor %}</select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Factory</label><select name="factory_id" class="w-full bg-black/40 border border-gray-600 p-4 rounded-xl text-white outline-none focus:border-neon">{% for fac in factories %}<option value="{{ fac }}">{{ fac }}</option>{% endfor %}</select></div>
                <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Quantity</label><input type="number" name="quantity" class="w-full bg-black/40 border border-gray-600 p-4 rounded-xl text-white outline-none focus:border-neon"></div>
                <button type="submit" class="w-full bg-neon text-black font-bold p-4 rounded-xl hover:bg-white transition mt-4">CONFIRM & START</button>
            </form>
        </div>
        {% endif %}

        {% if mode == 'reco_menu' %}<div class="text-center mb-10"><h2 class="font-display text-4xl font-bold">Select Recommendation Type</h2></div><div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto"><a href="/form/materials" class="glass-card p-10 rounded-2xl text-center group"><i data-lucide="layers" class="w-12 h-12 text-neon mx-auto mb-4 group-hover:scale-110 transition"></i><h3 class="font-display text-2xl font-bold">Material Sourcing</h3></a><a href="/form/factories" class="glass-card p-10 rounded-2xl text-center group"><i data-lucide="factory" class="w-12 h-12 text-blue-400 mx-auto mb-4 group-hover:scale-110 transition"></i><h3 class="font-display text-2xl font-bold">Factory Matching</h3></a></div>{% endif %}
        {% if mode == 'mat_form' %}<div class="max-w-xl mx-auto glass-card p-10 rounded-3xl"><h2 class="font-display text-3xl font-bold mb-6 text-center">Material Config</h2><form action="/process_materials" method="post" class="space-y-6"><div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Product Type</label><select name="product_type" class="w-full bg-black/40 border border-gray-600 p-4 rounded-xl text-white outline-none focus:border-neon">{% for prod in products %}<option value="{{ prod }}">{{ prod }}</option>{% endfor %}</select></div><button type="submit" class="w-full bg-neon text-black font-bold p-4 rounded-xl hover:bg-white transition">ANALYZE</button></form></div>{% endif %}
        {% if mode == 'fac_form' %}<div class="max-w-xl mx-auto glass-card p-10 rounded-3xl"><h2 class="font-display text-3xl font-bold mb-6 text-center">Factory Config</h2><form action="/process_factories" method="post" class="space-y-6"><div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Product</label><select name="product_type" class="w-full bg-black/40 border border-gray-600 p-4 rounded-xl text-white outline-none focus:border-neon">{% for prod in products %}<option value="{{ prod }}">{{ prod }}</option>{% endfor %}</select></div><div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Fabric</label><select name="fabric_type" class="w-full bg-black/40 border border-gray-600 p-4 rounded-xl text-white outline-none focus:border-neon">{% for fab in fabrics %}<option value="{{ fab }}">{{ fab }}</option>{% endfor %}</select></div><div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">Quantity</label><input type="number" name="quantity" class="w-full bg-black/40 border border-gray-600 p-4 rounded-xl text-white outline-none focus:border-neon"></div><button type="submit" class="w-full bg-blue-500 text-white font-bold p-4 rounded-xl hover:bg-blue-400 transition">FIND FACTORIES</button></form></div>{% endif %}
        {% if mode == 'mat_result' %}<h2 class="font-display text-3xl font-bold mb-8">Recommended Materials</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6">{% for mat in materials %}<div class="glass-card p-6 rounded-xl {% if mat.glow %}border-neon shadow-neon{% endif %}"><h3 class="font-display text-xl font-bold mb-4">{{ mat.name }}</h3><div class="space-y-2 text-sm text-gray-300"><div class="flex justify-between"><span>Price:</span><span class="text-white font-mono">{{ mat.price }}</span></div><div class="flex justify-between"><span>Score:</span><span class="text-white font-mono">{{ mat.durability }}</span></div></div></div>{% endfor %}</div>{% endif %}
        {% if mode == 'fac_result' %}<div class="glass-card p-8 rounded-3xl border-neon shadow-neon mb-10"><div class="flex justify-between items-center"><div><span class="bg-neon text-black text-[10px] px-3 py-1 rounded font-bold uppercase">BEST MATCH</span><h2 class="text-5xl font-display font-bold mt-2">{{ best_match.name }}</h2></div><div class="text-right"><p class="text-6xl font-display font-bold text-neon">{{ best_match.score }}</p></div></div><div class="grid grid-cols-3 gap-4 mt-8 border-t border-gray-700 pt-6"><div><p class="text-xs text-gray-500 uppercase">Time</p><p class="text-xl font-bold">{{ best_match.time }}</p></div><div><p class="text-xs text-gray-500 uppercase">Capacity</p><p class="text-xl font-bold">{{ best_match.cap }}</p></div><div><p class="text-xs text-gray-500 uppercase">Rating</p><p class="text-xl font-bold text-yellow-400">★ {{ best_match.rating }}</p></div></div></div>{% endif %}

    </main>

    <script>
        lucide.createIcons();
        
        // منطق الشات بوت لربط الواجهة بالباك اند
        const chatForm = document.getElementById('chat-form');
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const msg = userInput.value.trim();
            if(!msg) return;

            userInput.value = '';
            chatBox.innerHTML += `<div class="bg-purple-500/20 p-4 rounded-2xl rounded-br-none max-w-[80%] self-end text-right border border-purple-500/30 text-sm">${msg}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: `message=${encodeURIComponent(msg)}`
                });
                const data = await response.json();
                chatBox.innerHTML += `<div class="bg-white/5 p-4 rounded-2xl rounded-bl-none max-w-[80%] self-start border border-white/10 text-sm">${data.reply}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (err) {
                chatBox.innerHTML += `<div class="text-red-400 text-xs self-center">Connection failed</div>`;
            }
        }
    </script>
</body>
</html>